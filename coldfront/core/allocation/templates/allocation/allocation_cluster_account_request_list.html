{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load common_tags %}
{% load static %}


{% block title %}
Cluster Account Review New and Pending Requests
{% endblock %}


{% block content %}
<h1>Cluster Access Requests</h1>

<div class="table-responsive">
  <table class="table table-sm">
    <tbody>
      <tr>
        <td>
          Below is a list of cluster access requests that are either pending or
          being processed on the cluster. Requests are created when project
          join requests that have completed their delay period are
          automatically approved, which occurs periodically. You may manually
          perform this step using the Refresh button.
        </td>
        <td>
          <form method="post" action="{% url 'project-auto-approve-join-requests' %}">
            {% csrf_token %}
            <button class="btn btn-primary mr-1" type="submit">
              <i class="fas fa-sync" aria-hidden="true"></i>
              Refresh
            </button>
          </form>
        </td>
      </tr>
    </tbody>
  </table>
</div>

{% if cluster_account_list %}
<div class="table-responsive">
  <table class="table table-sm">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">Date Requested/<br>Last Modified</th>
        <th scope="col">User Email</th>
        <th scope="col">Cluster Username</th>
        <th scope="col">Project</th>
        <th scope="col">Allocation</th>
        <th scope="col">Status</th>
        <th scope="col">Allocation Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cluster_account in cluster_account_list %}
      <tr>
        <td>{{ cluster_account.pk }}</a></td>
        <td>{{ cluster_account.modified|date:"M. d, Y" }}</td>
        <td>{{ cluster_account.allocation_user.user.email }}</td>
        <td>
          {% if cluster_account.allocation_user.user.userprofile.cluster_uid %}
            {{ cluster_account.allocation_user.user.username }}
          {% else %}
            <span class="badge badge-danger">
              No cluster account.
            </span>
          {% endif %}
        </td>
        <td>
          <a href="{% url 'project-detail' cluster_account.allocation.project.pk %}">
            {{ cluster_account.allocation.project.name }}
          </a>
        </td>
        <td>
          <a href="{% url 'allocation-detail' cluster_account.allocation.pk %}">
            {{ cluster_account.allocation.pk }}
          </a>
        </td>
        <td>
          <span class="badge badge-warning">
            {% if cluster_account.value == "Pending - Add" %}
              Pending
            {% else %}
              {{ cluster_account.value }}
            {% endif %}
          </span>
        </td>
        <td class="text-nowrap">
          {% if cluster_account.value == "Pending - Add" %}
            <a href="{% url 'allocation-cluster-account-update-status' cluster_account.pk %}" class="btn btn-success mr-1">
              Activate
            </a>
          {% else %}
            <a href="{% url 'allocation-cluster-account-activate-request' cluster_account.pk %}" class="btn btn-success mr-1">
              Activate
            </a>
          {% endif %}
            <div class="modal fade" id="denial{{ cluster_account.pk }}Modal" tabindex="-1" role="dialog" aria-labelledby="denial{{ cluster_account.pk }}ModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <form action="{% url 'allocation-cluster-account-deny-request' cluster_account.pk %}" method="get" id="denial{{ cluster_account.pk }}Form">
                    {% csrf_token %}
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Deny Request</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <label>Are You Sure?</label>

                            <br><b>User:</b> {{ cluster_account.allocation_user.user.email }}
                            <br><b>Project:</b> {{ cluster_account.allocation.project.name }}
                            <br><b>Allocation:</b> {{ cluster_account.allocation.pk }}
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button class="btn btn-danger mr-1" type="submit">
                                Yes, deny this request.
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            </div>

            <button class="btn btn-danger mr-1" data-toggle="modal" data-target="#denial{{ cluster_account.pk }}Modal">
                Deny
            </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">
  No new or pending cluster account requests!
</div>
{% endif %}

<script>
  $("#navbar-main > ul > li.active").removeClass("active");
  $("#navbar-admin").addClass("active");
  $("#navbar-allocation-cluster-account-requests").addClass("active");
</script>

{% endblock %}
