<table class="table table-sm">
  <thead>
  <tr>
    <th scope="col">
      #
    </th>
    <th scope="col">
      Username
      {% include 'common/table_sorter.html' with table_sorter_field='project_user__user__username' %}
    </th>
    <th scope="col">
      User Email
      {% include 'common/table_sorter.html' with table_sorter_field='project_user__user__email' %}
    </th>
    <th scope="col">
      Project
      {% include 'common/table_sorter.html' with table_sorter_field='project_user__project' %}
    </th>
    <th scope="col">
      Date Requested
      {% include 'common/table_sorter.html' with table_sorter_field='created' %}
    </th>
    <th scope="col">
      Reason
    </th>
    <th scope="col">
      Timeline
    </th>
  </tr>
  </thead>
  <tbody>
  {% for join_request in queryset %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>
        {{ join_request.project_user.user.username }}
      </td>
      <td>{{ join_request.project_user.user.email }}</td>
      <td>
        <a href="{% url 'project-detail' join_request.project_user.project.pk %}">
          {{ join_request.project_user.project.name }}
        </a>
      </td>
      <td>{{ join_request.created|date:"M. d, Y" }}</td>
      <td>
        {{ join_request.reason }}
      </td>
      <td>
        {% if join_request.has_tracking %}
          <a href="#" data-toggle="modal" data-target="#projectAccessTimelineModal{{ join_request.project_user.project.pk }}_{{ join_request.project_user.user.pk }}">
            <i class="fas fa-clock"></i> View
          </a>
          <!-- Modal with unique ID for user-project combination -->
          <div class="modal fade" id="projectAccessTimelineModal{{ join_request.project_user.project.pk }}_{{ join_request.project_user.user.pk }}" tabindex="-1" role="dialog" aria-labelledby="projectAccessTimelineModalLabel{{ join_request.project_user.project.pk }}_{{ join_request.project_user.user.pk }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="projectAccessTimelineModalLabel{{ join_request.project_user.project.pk }}_{{ join_request.project_user.user.pk }}">
                    Project Access Tracking - {{ join_request.project_user.project.name }}
                    <br><small class="text-muted">User: {{ join_request.project_user.user.username }}</small>
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  {% if join_request.tracking_error %}
                    <div class="alert alert-danger" role="alert">
                      <i class="fas fa-exclamation-triangle"></i>
                      {{ join_request.tracking_error }}
                    </div>
                  {% elif join_request.tracking_status %}
                    <div class="mb-3">
                      <p><strong>Status:</strong> {{ join_request.tracking_status.message }}</p>
                      {% if join_request.tracking_status.details %}
                        {% if join_request.tracking_status.details.request_date %}
                          <p><strong>Request Date:</strong> {{ join_request.tracking_status.details.request_date|date:"M d, Y g:i A" }}</p>
                        {% endif %}
                        {% if join_request.tracking_status.details.reason %}
                          <p><strong>Request Reason:</strong> {{ join_request.tracking_status.details.reason }}</p>
                        {% endif %}
                      {% endif %}
                    </div>

                    <!-- Dell Design System Progress Tracker -->
                    <div class="dds__progress-tracker" role="list" aria-label="Project access progress">
                      <ol class="dds__progress-tracker__list">
                        {% for step in join_request.tracking_status.steps %}
                          <li class="dds__progress-tracker__list-item {% if step.completed %}dds__progress-tracker__list-item--completed{% elif step.current %}dds__progress-tracker__list-item--current{% endif %}" role="listitem">
                            <span class="dds__progress-tracker__list-item-label">
                              {% if step.completed %}
                                <svg class="dds__progress-tracker__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true">
                                  <path d="M6.5 11.793l-4.146-4.147a.5.5 0 0 0-.708.708l4.5 4.5a.5.5 0 0 0 .708 0l8-8a.5.5 0 0 0-.708-.708L6.5 11.793z"/>
                                </svg>
                              {% elif step.current %}
                                <span class="dds__progress-tracker__number" aria-hidden="true">{{ forloop.counter }}</span>
                              {% else %}
                                <span class="dds__progress-tracker__number" aria-hidden="true">{{ forloop.counter }}</span>
                              {% endif %}
                              <span class="dds__progress-tracker__text">{{ step.label }}</span>
                            </span>
                          </li>
                        {% endfor %}
                      </ol>
                    </div>
                  {% else %}
                    <div class="alert alert-info" role="alert">
                      <i class="fas fa-info-circle"></i>
                      No tracking information available.
                    </div>
                  {% endif %}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<!-- Include CSS if not already on page -->
<style>
/* Dell Design System Progress Tracker Styles */
.dds__progress-tracker {
  margin: 2rem 0;
}

.dds__progress-tracker__list {
  display: flex;
  justify-content: space-between;
  list-style: none;
  padding: 0;
  margin: 0;
  position: relative;
}

.dds__progress-tracker__list::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 2px;
  background-color: #e7e7e7;
  z-index: -1;
  transform: translateY(-50%);
}

.dds__progress-tracker__list-item {
  flex: 1;
  text-align: center;
  position: relative;
}

.dds__progress-tracker__list-item-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.dds__progress-tracker__number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  background-color: #ffffff;
  border: 2px solid #e7e7e7;
  color: #6c757d;
  font-weight: 600;
  font-size: 0.875rem;
  position: relative;
  z-index: 1;
}

.dds__progress-tracker__icon {
  width: 2rem;
  height: 2rem;
  fill: #ffffff;
  background-color: #0072c9;
  border-radius: 50%;
  padding: 0.25rem;
  position: relative;
  z-index: 1;
}

.dds__progress-tracker__text {
  font-size: 0.875rem;
  color: #333;
  max-width: 120px;
}

.dds__progress-tracker__list-item--completed .dds__progress-tracker__number {
  display: none;
}

.dds__progress-tracker__list-item--completed::before {
  content: '';
  position: absolute;
  top: 50%;
  left: -50%;
  right: 50%;
  height: 2px;
  background-color: #0072c9;
  z-index: 0;
  transform: translateY(-50%);
}

.dds__progress-tracker__list-item:first-child::before {
  display: none;
}

.dds__progress-tracker__list-item--current .dds__progress-tracker__number {
  background-color: #0072c9;
  border-color: #0072c9;
  color: #ffffff;
}

.dds__progress-tracker__list-item--current .dds__progress-tracker__text {
  font-weight: 600;
}

.dds__progress-tracker__list-item--current::before {
  content: '';
  position: absolute;
  top: 50%;
  left: -50%;
  right: 50%;
  height: 2px;
  background-color: #0072c9;
  z-index: 0;
  transform: translateY(-50%);
}

@media (max-width: 768px) {
  .dds__progress-tracker__list {
    flex-direction: column;
    align-items: flex-start;
  }

  .dds__progress-tracker__list::before {
    top: 0;
    bottom: 0;
    left: 1rem;
    width: 2px;
    height: auto;
    transform: none;
  }

  .dds__progress-tracker__list-item {
    text-align: left;
    margin-bottom: 2rem;
  }

  .dds__progress-tracker__list-item:last-child {
    margin-bottom: 0;
  }

  .dds__progress-tracker__list-item-label {
    flex-direction: row;
  }

  .dds__progress-tracker__list-item::before {
    top: -1rem;
    bottom: -1rem;
    left: 1rem;
    width: 2px;
    height: auto;
    transform: translateX(-50%);
  }

  .dds__progress-tracker__list-item--completed::before,
  .dds__progress-tracker__list-item--current::before {
    top: -1rem;
    bottom: 50%;
  }
}
</style>