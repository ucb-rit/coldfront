# ColdFront Production Docker Deployment

This directory contains the production Docker Compose configuration for containerized ColdFront deployments.

## Architecture

**Containerized Services:**
- `web`: Django application served by Gunicorn with Uvicorn ASGI workers
- `qcluster`: Background worker for async tasks (Django-Q)

**Host Services (systemd):**
- PostgreSQL 15
- Redis
- Postfix (+OpenDKIM for BRC)
- Nginx (reverse proxy)

## Prerequisites

1. **Host services running:**
   - PostgreSQL, Redis, Postfix, Nginx installed and configured via Ansible
   - Services accessible from Docker containers via `host.docker.internal`

2. **Docker image built:**
   ```bash
   docker build -t coldfront-app-production:latest --target coldfront-app-production .
   ```

3. **Environment file configured:**
   - `.env` file generated by Ansible from `templates/env.j2`
   - Contains all Django configuration as environment variables
   - **Includes all secrets** (database passwords, secret keys, etc.)

## Directory Structure

```
bootstrap/production/docker/
├── docker-compose.yml          # Production compose configuration
├── .env                        # Environment variables + secrets (generated by Ansible)
├── scripts/                    # Helper scripts
│   └── run_django_commands.sh  # Run Django management commands
└── README.md                   # This file
```

## Usage

### Starting Services

```bash
# Start all services
docker compose -f bootstrap/production/docker/docker-compose.yml up -d

# Check status
docker compose -f bootstrap/production/docker/docker-compose.yml ps

# View logs
docker compose -f bootstrap/production/docker/docker-compose.yml logs -f web
docker compose -f bootstrap/production/docker/docker-compose.yml logs -f qcluster
```

### Stopping Services

```bash
# Stop all services
docker compose -f bootstrap/production/docker/docker-compose.yml down

# Stop and remove volumes (DANGEROUS - will delete data)
docker compose -f bootstrap/production/docker/docker-compose.yml down -v
```

### Running Django Management Commands

Use the helper script:

```bash
./bootstrap/production/docker/scripts/run_django_commands.sh
```

Or manually:

```bash
# Run migrations
docker compose -f bootstrap/production/docker/docker-compose.yml exec web python manage.py migrate

# Collect static files
docker compose -f bootstrap/production/docker/docker-compose.yml exec web python manage.py collectstatic --noinput

# Create superuser
docker compose -f bootstrap/production/docker/docker-compose.yml exec web python manage.py createsuperuser
```

### Health Checks

Check service health:

```bash
# Check web health
curl http://localhost:8000/health/

# Check via Docker
docker compose -f bootstrap/production/docker/docker-compose.yml ps
```

### Updating Deployment

```bash
# Pull new image
docker pull coldfront-app-production:${IMAGE_TAG}

# Restart services with new image
docker compose -f bootstrap/production/docker/docker-compose.yml up -d --force-recreate

# Or use Ansible playbook (recommended)
ansible-playbook bootstrap/ansible-containerized/playbook.yml
```

## Configuration

### Environment Variables

Environment variables are loaded from `.env` file. Key variables:

- `IMAGE_TAG`: Docker image tag (default: `latest`)
- `WEB_PORT`: External port for web service (default: `8000`)

**Note:** Gunicorn settings (workers, timeout, log level) are configured via command-line arguments in `docker-compose.yml`. These can be moved to a `gunicorn.conf.py` file if the configuration becomes complex.

See `.env.template` in the repository root for complete list of Django settings.

### Secrets Management

All secrets are stored in the `.env` file as environment variables.

**Security considerations:**
- `.env` file must have permissions `0600` (read/write by owner only)
- **Never commit `.env` to version control!** (already in `.gitignore`)
- Generated by Ansible from CI/CD secrets or vault
- Secrets are injected as environment variables (not mounted files)

## Connecting to Host Services

Containers connect to host services via `host.docker.internal`:

- PostgreSQL: `host.docker.internal:5432`
- Redis: `host.docker.internal:6379`
- Postfix: `host.docker.internal:25`

**Important:** Ensure host services allow connections from Docker network:

- PostgreSQL `pg_hba.conf`: Allow connections from Docker subnet
- Redis `redis.conf`: Bind to `0.0.0.0` or Docker interface
- Firewall: Allow traffic from Docker network

## Troubleshooting

### Container won't start

```bash
# Check logs
docker compose -f bootstrap/production/docker/docker-compose.yml logs web

# Check environment variables
docker compose -f bootstrap/production/docker/docker-compose.yml exec web env | grep DJANGO
```

### Can't connect to host services

```bash
# Test from within container
docker compose -f bootstrap/production/docker/docker-compose.yml exec web ping host.docker.internal
docker compose -f bootstrap/production/docker/docker-compose.yml exec web nc -zv host.docker.internal 5432
docker compose -f bootstrap/production/docker/docker-compose.yml exec web nc -zv host.docker.internal 6379
```

### Health check failing

```bash
# Check health endpoint directly
docker compose -f bootstrap/production/docker/docker-compose.yml exec web curl -v http://localhost:8000/health/

# Check healthcheck logs
docker inspect coldfront-web | jq '.[0].State.Health'
```

### Performance issues

```bash
# Check resource usage
docker stats coldfront-web coldfront-qcluster

# Adjust Gunicorn workers by editing docker-compose.yml
# Change --workers=4 to desired number, then:
docker compose -f bootstrap/production/docker/docker-compose.yml up -d --force-recreate
```

## Security Considerations

1. **Secrets**: Never commit `.env` file to version control (contains all secrets)
2. **Permissions**: `.env` file must be mode `0600` (read/write by owner only)
3. **User**: Containers run as `nobody` user (non-root)
4. **Network**: Only necessary ports are exposed
5. **Updates**: Regularly update base images and dependencies

## Monitoring

- **Health checks**: Built into Docker Compose, monitored by orchestrator
- **Application logs**: Streamed to stdout/stderr, collected by Docker logging driver
- **Host metrics**: Datadog agent on host
- **Application metrics**: (Future) OpenTelemetry collector sidecar

## Future Enhancements

- Blue/green deployment support
- OpenTelemetry collector integration
- Automated database backups from containers
- Multi-datacenter deployment support
- Horizontal scaling of web workers
